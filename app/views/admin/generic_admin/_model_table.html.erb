<% join_char = request.fullpath.index('?') ? "&" : "?"%>

<div class="model-table">

  <div class="model-table-top-action">
    <p class="model-table-summary">
      <strong class="model"><%= instance_variable_get("@#{plural_name}").total_count %></strong> matching <%= plural_name.humanize.downcase %>
    </p>
    <!-- <nav class="model-table-actions"><%= link_to 'Export to CSV <span class="icon-table"></span>'.html_safe, request.fullpath + join_char + "format=csv" %></nav> -->
  </div>

  <table class="table">
    <thead>
      <tr>
        <% index_columns.each do |col_name| -%>
          <% if col_name.is_a?(Array) %>
            <th><%= col_name[0] %></th>
          <% else %>
            <th><%= link_to col_name.humanize, params.merge(:order => order_param(col_name)) %></th>
          <% end %>
        <% end -%>
        <th></th>
      </tr>
    </thead>

    <tbody data-behavior="<%= "sortable" if model_class.respond_to?(:positionable) %>" data-model="<%= model_class %>">
      <% instance_variable_get("@#{plural_name}").each do |model| %>
        <tr id="<%= singular_name %>_<%= model.id %>" class="<%= cycle 'even','odd' %> sort-item" data-item-id="<%= model.id %>">
          <% index_columns.each do |col_name| -%>
            <% if col_name.is_a?(Array) %>
              <td><%= col_name[1].call(model) %></td>
            <% else %>
              <% col = model.class.columns.find {|c| c.name == col_name || c.name.downcase == col_name.downcase } %>

              <% if col.type == :datetime -%>
                <td><%= model.send(col.name).to_s(:admin) if model.send(col.name) %></td>
              <% elsif col.type == :date -%>
                <td><%= model.send(col.name).to_s(:admin) if model.send(col.name) %></td>
              <%# elsif thumb_columns.include?(col.name) %>
                <!-- <td class="thumb"><%#= image_tag(model.send(col.name)) if model.send(col.name) %></td> -->
              <% elsif [:string, :text].include? col.type -%>
                <td><%= truncate(model.send(col.name), :length => 150) %></td>
              <% elsif col.name == "id" %>
                <td><%= link_to model.id, edit_path(model) %></td>
              <% elsif col.name =~ /_id$/ %>
                <% association = model.send(col.name.gsub("_id",'')) %>
                <td><%= association.try(:to_s) %></td>
              <% elsif col.type == :boolean %>
                <td><span class="label <%= model.send(col.name) %>"><%= model.send(col.name) %></span></td>
              <% else %>
                <td><%= model.send(col.name) %></td>
              <% end -%>
            <% end %>
          <% end -%>
          <td class="edit">
            <%= link_to '<i class="icon-edit"></i>'.html_safe, edit_path(model), title: "Edit" %>
            <%= link_to '<i class="icon-trash"></i>'.html_safe, model_path(model), title: "Delete", :method => :delete, :data => { :confirm => "Are you sure you want to delete this item?" } %>
          </td>
        </tr>
      <% end -%>
    </tbody>
  </table>

</div>

<%= paginate instance_variable_get("@#{plural_name}") %>
